<!-- backend/templates/login.html -->
<!DOCTYPE html>
<html>
  <head>
    <title>Login</title>
    <!-- Include Firebase SDKs from version 10.14.1 -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.1.1/firebase-ui-auth.js"></script>
    <link
      type="text/css"
      rel="stylesheet"
      href="https://www.gstatic.com/firebasejs/ui/6.1.1/firebase-ui-auth.css"
    />
    <script>
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyA6zpoyx3DPFTydwFUB11drJAiyfOWRwWA",
        authDomain: "hackathonproject-89255.firebaseapp.com",
        projectId: "hackathonproject-89255",
        storageBucket: "hackathonproject-89255.appspot.com",
        messagingSenderId: "414382919249",
        appId: "1:414382919249:web:c06b40bb5cc309288c3270",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth(); // Use firebase.auth() to initialize auth

      // FirebaseUI config.
      const uiConfig = {
        signInSuccessUrl: "/",
        signInOptions: [
          firebase.auth.GoogleAuthProvider.PROVIDER_ID,
          //   firebase.auth.FacebookAuthProvider.PROVIDER_ID,
          //   firebase.auth.TwitterAuthProvider.PROVIDER_ID,
          //   firebase.auth.GithubAuthProvider.PROVIDER_ID,
          firebase.auth.EmailAuthProvider.PROVIDER_ID, // IMPORTANT: https://github.com/firebase/firebaseui-web/issues/1040
          //   firebase.auth.PhoneAuthProvider.PROVIDER_ID,
        ],
        // Set to false to disable account chooser
        credentialHelper: firebaseui.auth.CredentialHelper.NONE,
        tosUrl: "/terms-of-service",
        privacyPolicyUrl: function () {
          window.location.assign("/privacy");
        },
      };

      // Initialize the FirebaseUI Widget using Firebase.
      const ui = new firebaseui.auth.AuthUI(auth); // Use the initialized auth
      window.onload = function () {
        ui.start("#firebaseui-auth-container", uiConfig);
      };
      // Add the auth listener that fires when auth state changes
      auth.onAuthStateChanged((user) => {
        console.log({ user });
        if (user) {
          // User is signed in.
          console.log("Firebase: User is signed in. Creating the session.");
          user.getIdToken().then((idToken) => {
            // Send the ID token to your Flask server
            fetch("/login", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ idToken: idToken }),
            }).then((response) => {
              if (response.ok) {
                // Handle successful login
                console.log("Backend: Session started.");
              } else {
                // Handle login error
                console.error("Backend: Unable to create session.");
              }
            });
          });
        } else {
          // User is signed out.
          console.log("Firebase: User is signed out");
        }
      });
      // Sign-out function
      function signOut() {
        auth
          .signOut()
          .then(() => {
            console.log("Firebase: User signed out.");
            fetch("/logout", {
              method: "GET",
            }).then((response) => {
              if (response.ok) {
                console.log("Session: Logged out successfully.");
                // Optionally, redirect or update the UI after logout
                window.location.reload(); // Reload the page or redirect
              } else {
                console.error("Session: Failed to log out.");
              }
            });
          })
          .catch((error) => {
            console.error("Sign-out error:", error);
          });
      }
    </script>
  </head>
  <body>
    <!-- The element where FirebaseUI will render -->
    <div id="firebaseui-auth-container"></div>
    <button onclick="signOut()">Sign Out</button>
  </body>
</html>
